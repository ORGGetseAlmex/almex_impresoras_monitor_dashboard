# -----------------------------------------
# üì¶ .github/workflows/deploy.yml
# ‚öôÔ∏è Script: Pipeline de despliegue de p√°gina web en PHP con Composer y Apache
# üôç Autor: Bryan Daniel
# üìÖ Fecha: 2025-07-03
# -----------------------------------------
name: Despliegue por etapas
 
on:
  push:
    branches: [ "main","dev" ]
 
jobs:
  deploy:
    name: üöö Stage 1 - Despliegue de archivos
    runs-on: self-hosted
 
    outputs:
      repo_name: ${{ steps.setvars.outputs.repo_name }}
      branch_name: ${{ steps.setvars.outputs.branch_name }}
 
    steps:
      - name: üß© Checkout del repositorio
        uses: actions/checkout@v3
 
      - name: üõ†Ô∏è Obtener nombre del repo y branch
        id: setvars
        run: |
          echo "repo_name=${GITHUB_REPOSITORY##*/}" >> "$GITHUB_OUTPUT"
          echo "branch_name=${GITHUB_REF##*/}" >> "$GITHUB_OUTPUT"
 
      - name: üîë Ajustar permisos antes de copiar
        run: |
          TARGET_DIR="/var/www/${{ steps.setvars.outputs.repo_name }}_${{ steps.setvars.outputs.branch_name }}"
          echo "Preparando permisos para $TARGET_DIR"
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S mkdir -p "$TARGET_DIR"
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chown -R github-action:github-action "$TARGET_DIR"
          echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chmod -R 755 "$TARGET_DIR"
 
      - name: üìÅ Desplegar a carpeta din√°mica
        run: |
          TARGET_DIR="/var/www/${{ steps.setvars.outputs.repo_name }}_${{ steps.setvars.outputs.branch_name }}"
          rsync -av --delete --exclude='.git' ./ "$TARGET_DIR/"
 
  composer:
    name: üì¶ Stage 2 - Instalar dependencias Composer
    runs-on: self-hosted
    needs: deploy
 
    steps:
      - name: Instalar Composer si aplica
        run: |
          TARGET_DIR="/var/www/${{ needs.deploy.outputs.repo_name }}_${{ needs.deploy.outputs.branch_name }}"
          if [ -f "$TARGET_DIR/composer.json" ]; then
            echo "üì¶ Ejecutando Composer en $TARGET_DIR"
            cd "$TARGET_DIR"
            sudo -u github-action composer install --no-interaction --prefer-dist --no-dev
          else
            echo "‚ö†Ô∏è No se encontr√≥ composer.json"
          fi